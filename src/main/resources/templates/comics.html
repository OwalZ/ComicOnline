<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
  th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}"
>
  <head>
    <title>Cat√°logo - ComicOnline</title>
  </head>
  <main>
    <!-- Futuristic Catalog Control Bar -->
    <div class="catalog-neo mb-4">
      <div class="catalog-neo__header">
        <div>
          <h1 class="catalog-title m-0">Cat√°logo</h1>
          <div class="catalog-sub text-dim small">
            Local + Comunidad externa
          </div>
        </div>
        <span
          class="badge badge-frost catalog-count"
          id="countAll"
          th:text="${#lists.size(comics)} + ' locales'"
          >0</span
        >
        <div class="catalog-views ms-auto d-none d-md-flex">
          <button
            type="button"
            class="view-btn is-active"
            data-view="grid"
            title="Vista grid"
          >
            ‚ñ¶
          </button>
          <button
            type="button"
            class="view-btn"
            data-view="list"
            title="Vista lista"
          >
            ‚ò∞
          </button>
        </div>
      </div>
      <div class="catalog-neo__controls mt-3 gap-3">
        <div class="search-fx flex-grow-1">
          <input
            id="searchExt"
            class="search-fx-input"
            placeholder="Buscar externo ‚Ä¢ ENTER"
            autocomplete="off"
          />
          <div class="search-fx-glow"></div>
          <button id="btnSearchExt" class="search-fx-btn" title="Buscar">
            üîç
          </button>
        </div>
        <div class="lang-select-wrap">
          <select id="extLang" class="lang-select" title="Idioma externo">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="pt-br">PT</option>
            <option value="fr">FR</option>
            <option value="it">IT</option>
            <option value="de">DE</option>
            <option value="ru">RU</option>
            <option value="ja">JA</option>
            <option value="ko">KO</option>
            <option value="zh">ZH</option>
          </select>
        </div>
        <div class="rating-chips" id="ratingChips" aria-label="Filtro rating">
          <button class="chip active" data-rating="safe" title="Safe">
            safe
          </button>
          <button
            class="chip active"
            data-rating="suggestive"
            title="Suggestive"
          >
            suggestion
          </button>
          <button class="chip" data-rating="erotica" title="Erotica">
            erotic
          </button>
          <button class="chip" data-rating="pornographic" title="Pornographic">
            pornographic
          </button>
        </div>
        <div
          class="toggle-nsfw small d-flex align-items-center gap-2"
          title="Incluir NSFW extremo"
        >
          <input class="form-check-input m-0" type="checkbox" id="toggleNsfw" />
          <label for="toggleNsfw" class="m-0">NSFW</label>
        </div>
      </div>
      <div class="catalog-neo__hint small text-dim mt-2">
        CONSEJO: Usa ENTER para nueva b√∫squeda ‚Ä¢ Click en una tarjeta para vista
        r√°pida ‚Ä¢ Flechas navegan p√°ginas en el lector.
      </div>
    </div>
    <div class="grid-auto-fill anim-fade-up" id="catalogGrid">
      <div th:each="c : ${comics}">
        <div class="card h-100">
          <div
            class="ratio ratio-4x3 d-flex align-items-center justify-content-center text-dim fw-semibold"
          >
            Portada
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1" th:text="${c.title}"></h5>
            <p class="small text-dim mb-3" th:text="${c.author}"></p>
            <div class="mt-auto d-flex gap-2">
              <a
                th:href="@{'/comics/' + ${c.id}}"
                class="btn btn-outline-frost btn-sm"
                >Ver</a
              >
              <a
                th:href="@{'/comics/' + ${c.id} + '/read'}"
                class="btn btn-gradient btn-sm"
                >Leer</a
              >
            </div>
          </div>
        </div>
      </div>
      <div th:if="${#lists.isEmpty(comics)}" id="noComicsMsg" class="text-dim">
        No hay c√≥mics.
      </div>
    </div>
    <!-- Paginaci√≥n resultados externos -->
    <div
      id="extPager"
      class="mt-4 d-flex flex-wrap gap-2 justify-content-center pager-scroll"
    ></div>
    <!-- Modal salto de p√°gina (se activar√° reemplazando prompt) -->
    <div class="modal fade" id="jumpModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass">
          <div class="modal-header py-2">
            <h5 class="modal-title small">Ir a p√°gina</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body py-3">
            <input
              type="number"
              min="1"
              class="form-control form-control-sm"
              id="jumpInput"
              placeholder="N√∫mero de p√°gina"
            />
          </div>
          <div class="modal-footer py-2">
            <button
              type="button"
              class="btn btn-outline-frost btn-sm"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-gradient btn-sm" id="jumpGo">
              Ir
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="authFlag"
      sec:authorize="isAuthenticated()"
      style="display: none"
    ></div>
    <template id="extCardTpl">
      <div class="card h-100 comic-card" data-quick>
        <div class="cover-wrap ratio ratio-4x3">
          <div class="cover-skeleton" data-skel></div>
          <img data-img loading="lazy" decoding="async" class="cover-img" />
          <div class="cover-overlay">
            <div class="overlay-actions">
              <button class="btn-action" data-chapters title="Cap√≠tulos">
                üìñ
              </button>
              <button
                class="btn-action"
                data-fav
                style="display: none"
                title="Favorito"
              >
                ‚òÜ
              </button>
            </div>
          </div>
          <span data-ph class="cover-fallback small">Sin portada</span>
        </div>
        <div class="card-body d-flex flex-column p-2">
          <h5 class="card-title small mb-1" data-title></h5>
          <div class="extra-row small text-dim" data-extra></div>
          <div class="pages-box mt-2 d-none" data-pagesBox></div>
        </div>
      </div>
    </template>
    <script>
      (function () {
        const input = document.getElementById("searchExt");
        const langSelect = document.getElementById("extLang");
        const btn = document.getElementById("btnSearchExt");
        const grid = document.getElementById("catalogGrid");
        const countAll = document.getElementById("countAll");
        const tpl = document.getElementById("extCardTpl").content;
        const localCount =
          grid.querySelectorAll("[data-local] , [th\\:each]").length ||
          document.querySelectorAll("[th\\:each] .card").length;
        const noComicsMsg = document.getElementById("noComicsMsg");
        function updateCount() {
          const extCount = grid.querySelectorAll(
            "[data-ext] .card, .card[data-ext]"
          ).length;
          countAll.textContent = `${
            localCount + extCount
          } total (${localCount} locales + ${extCount} ext)`;
          if (noComicsMsg) {
            if (localCount === 0 && extCount === 0) {
              noComicsMsg.style.display = "";
            } else {
              noComicsMsg.style.display = "none";
            }
          }
        }
        // --- Overlay lector ---
        const reader = document.createElement("div");
        reader.id = "extReader";
        reader.style.cssText =
          "position:fixed;inset:0;z-index:2000;display:none;background:rgba(0,0,0,.85);backdrop-filter:blur(6px);";
        reader.innerHTML = `
          <div style="position:absolute;inset:0;display:flex;flex-direction:column;">
            <div style="padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;">
              <button id="erClose" class="btn btn-outline-frost btn-sm">Cerrar</button>
              <div class="text-dim small" id="erTitle"></div>
              <div class="ms-auto d-flex align-items-center gap-2">
                <button id="erPrev" class="btn btn-outline-frost btn-sm">Prev</button>
                <span id="erPageInfo" class="badge badge-frost"></span>
                <button id="erNext" class="btn btn-outline-frost btn-sm">Next</button>
              </div>
            </div>
            <div id="erBody" style="flex:1;overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:1rem;">
              <div id="erLoading" class="text-dim">Cargando...</div>
            </div>
            <div style="padding:.5rem 1rem;display:flex;gap:.5rem;overflow:auto;" id="erThumbs" class="small"></div>
          </div>`;
        document.body.appendChild(reader);
        let pages = [];
        let pageIndex = 0;
        let currentMangaId = null;
        let currentChapterId = null;
        let currentChapterLabel = "";
        let currentChapters = [];
        let currentChapterPos = 0;
        const btnNext = () => reader.querySelector("#erNext");
        const erBody = reader.querySelector("#erBody");
        const erPageInfo = reader.querySelector("#erPageInfo");
        const erTitle = reader.querySelector("#erTitle");
        const erThumbs = reader.querySelector("#erThumbs");
        // --- External favorites support ---
        const auth = document.getElementById("authFlag") !== null;
        let extFavorites = new Set();
        function updateFavBtn(btn, active) {
          if (!btn) return;
          btn.style.display = "inline-block";
          if (active) {
            btn.classList.remove("btn-outline-frost");
            btn.classList.add("btn-gradient");
            btn.textContent = "‚òÖ Fav";
          } else {
            btn.classList.add("btn-outline-frost");
            btn.classList.remove("btn-gradient");
            btn.textContent = "‚òÜ Fav";
          }
        }
        function loadExternalFavorites() {
          if (!auth) return;
          fetch("/api/ext/fav")
            .then((r) => (r.status === 200 ? r.json() : null))
            .then((data) => {
              if (!data) return;
              extFavorites = new Set(
                (data.favorites || []).map((f) => f.externalId)
              );
              grid.querySelectorAll("[data-ext][data-mid]").forEach((c) => {
                updateFavBtn(
                  c.querySelector("[data-fav]"),
                  extFavorites.has(c.dataset.mid)
                );
              });
            });
        }
        function toggleFav(cardEl) {
          if (!auth) return;
          const id = cardEl.dataset.mid;
          const btn = cardEl.querySelector("[data-fav]");
          const payload = {
            id,
            title: cardEl.dataset.title || "",
            coverUrl: cardEl.dataset.cover || "",
            contentRating: cardEl.dataset.rating || "",
          };
          const csrf = document.querySelector('meta[name="_csrf"]')?.content;
          const csrfHeader = document.querySelector(
            'meta[name="_csrf_header"]'
          )?.content;
          const headers = { "Content-Type": "application/json" };
          if (csrf && csrfHeader) headers[csrfHeader] = csrf;
          fetch("/api/ext/fav/toggle", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          })
            .then((r) => r.json())
            .then((res) => {
              if (res.status === "added") extFavorites.add(id);
              else if (res.status === "removed") extFavorites.delete(id);
              updateFavBtn(btn, extFavorites.has(id));
            });
        }
        let progressTimer = null;
        function scheduleProgress() {
          if (progressTimer) clearTimeout(progressTimer);
          progressTimer = setTimeout(() => {
            if (!auth || !currentMangaId || !extFavorites.has(currentMangaId))
              return;
            const csrf = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector(
              'meta[name="_csrf_header"]'
            )?.content;
            const headers = { "Content-Type": "application/json" };
            if (csrf && csrfHeader) headers[csrfHeader] = csrf;
            fetch("/api/ext/fav/progress", {
              method: "POST",
              headers,
              body: JSON.stringify({
                id: currentMangaId,
                chapterId: currentChapterId,
                chapterLabel: currentChapterLabel,
                pageIndex,
              }),
            });
          }, 800);
        }
        function updateNextLabel() {
          const b = btnNext();
          if (!b) return;
          if (!pages.length) {
            b.textContent = "Next";
            return;
          }
          if (pageIndex === pages.length - 1) {
            if (currentChapterPos < currentChapters.length - 1)
              b.textContent = "Next Chapter";
            else b.textContent = "End";
          } else b.textContent = "Next";
        }
        function renderPage() {
          if (!pages.length) {
            erBody.innerHTML = '<div class="text-dim">Sin p√°ginas.</div>';
            erPageInfo.textContent = "0/0";
            return;
          }
          erBody.innerHTML = "";
          const container = document.createElement("div");
          container.style.width = "100%";
          container.style.display = "flex";
          container.style.flexDirection = "column";
          container.style.alignItems = "center";
          erBody.appendChild(container);
          // Cargar p√°gina actual inmediatamente
          const cur = createPageImg(pageIndex);
          container.appendChild(cur);
          // Pre-crear siguientes placeholders para lazy
          for (let i = pageIndex + 1; i < pages.length; i++) {
            const ph = document.createElement("div");
            ph.className = "page-ph";
            ph.style.minHeight = "60vh";
            ph.style.width = "90%";
            ph.style.margin = "2rem 0";
            ph.dataset.index = i;
            container.appendChild(ph);
          }
          erPageInfo.textContent = pageIndex + 1 + " / " + pages.length;
          Array.from(erThumbs.children).forEach((th, i) => {
            th.classList.toggle("active", i === pageIndex);
            th.style.opacity = i === pageIndex ? "1" : ".6";
          });
          updateNextLabel();
          scheduleProgress();
          initLazy(container);
        }
        function createPageImg(i) {
          const img = document.createElement("img");
          img.src = pages[i];
          img.style.maxWidth = "90%";
          img.style.borderRadius = "12px";
          img.style.boxShadow = "0 4px 24px -4px rgba(0,0,0,.8)";
          img.loading = "lazy";
          img.decoding = "async";
          return img;
        }
        function initLazy(container) {
          if (!("IntersectionObserver" in window)) return; // fallback
          const io = new IntersectionObserver(
            (entries) => {
              entries.forEach((ent) => {
                if (ent.isIntersecting) {
                  const ph = ent.target;
                  const idx = parseInt(ph.dataset.index, 10);
                  if (!isNaN(idx)) {
                    const img = createPageImg(idx);
                    ph.replaceWith(img);
                  }
                  io.unobserve(ph);
                }
              });
            },
            { root: erBody, rootMargin: "200px 0px", threshold: 0.01 }
          );
          container
            .querySelectorAll(".page-ph")
            .forEach((ph) => io.observe(ph));
        }
        function openReader(chapterId, label, chaptersArr, chapterIdx) {
          if (chaptersArr) currentChapters = chaptersArr;
          if (typeof chapterIdx === "number") currentChapterPos = chapterIdx;
          currentChapterId = chapterId;
          reader.style.display = "block";
          erTitle.textContent = "Cap√≠tulo " + label;
          erBody.innerHTML =
            '<div id="erLoading" class="text-dim">Cargando p√°ginas...</div>';
          erThumbs.innerHTML = "";
          pages = [];
          pageIndex = 0;
          currentChapterLabel = label;
          fetch("/api/ext/chapter/" + chapterId + "/pages")
            .then((r) => r.json())
            .then((data) => {
              pages = data.pages || [];
              pages.forEach((p, i) => {
                const th = document.createElement("img");
                th.src = p;
                th.style.height = "54px";
                th.style.cursor = "pointer";
                th.style.borderRadius = "6px";
                th.style.opacity = ".6";
                th.style.transition = ".2s";
                th.style.boxShadow = "0 0 0 2px rgba(255,255,255,.08)";
                th.addEventListener("click", () => {
                  pageIndex = i;
                  renderPage();
                });
                th.addEventListener(
                  "mouseenter",
                  () => (th.style.opacity = "1")
                );
                th.addEventListener("mouseleave", () => {
                  if (!th.classList.contains("active")) th.style.opacity = ".6";
                });
                erThumbs.appendChild(th);
              });
              renderPage();
            })
            .catch(() => {
              erBody.innerHTML =
                '<div class="text-danger">Error cargando p√°ginas.</div>';
            });
        }
        reader
          .querySelector("#erClose")
          .addEventListener("click", () => (reader.style.display = "none"));
        reader.querySelector("#erPrev").addEventListener("click", () => {
          if (pageIndex > 0) {
            pageIndex--;
            renderPage();
          }
        });
        reader.querySelector("#erNext").addEventListener("click", () => {
          if (pageIndex < pages.length - 1) {
            pageIndex++;
            renderPage();
            return;
          }
          // √∫ltima p√°gina: intentar siguiente cap√≠tulo
          if (currentChapterPos < currentChapters.length - 1) {
            const next = currentChapters[currentChapterPos + 1];
            openReader(
              next.id,
              next.chapter || "?",
              null,
              currentChapterPos + 1
            );
          }
        });
        document.addEventListener("keydown", (e) => {
          if (reader.style.display === "block") {
            if (e.key === "Escape") {
              reader.style.display = "none";
            } else if (e.key === "ArrowLeft") {
              if (pageIndex > 0) {
                pageIndex--;
                renderPage();
              }
            } else if (e.key === "ArrowRight") {
              if (pageIndex < pages.length - 1) {
                pageIndex++;
                renderPage();
              }
            }
          }
        });

        function enrichCard(n) {
          const chaptersBtn = n.querySelector("[data-chapters]");
          const extra = n.querySelector("[data-extra]");
          const pagesBox = n.querySelector("[data-pagesBox]");
          const favBtn = n.querySelector("[data-fav]");
          if (favBtn && auth) {
            updateFavBtn(favBtn, extFavorites.has(n.dataset.mid));
            favBtn.addEventListener("click", () => toggleFav(n));
          }
          chaptersBtn.addEventListener("click", () => {
            extra.textContent = "Cargando cap√≠tulos...";
            const id = n.dataset.mid;
            currentMangaId = id;
            const lang = langSelect.value;
            fetch(
              `/api/ext/manga/${id}/chapters?lang=${encodeURIComponent(lang)}`
            )
              .then((r) => r.json())
              .then((ch) => {
                renderChaptersBox({
                  card: n,
                  response: ch,
                  requestedLang: lang,
                  pagesBox,
                  extra,
                });
              });
          });
          // Click en toda la tarjeta abre cap√≠tulos (excepto si se pulsa un bot√≥n de acci√≥n)
          n.addEventListener("click", (ev) => {
            if (
              ev.target.closest("[data-chapters],[data-fav],.btn-action,button")
            )
              return; // ya manejado
            if (pagesBox && !pagesBox.classList.contains("d-none")) {
              // toggle ocultar
              pagesBox.classList.add("d-none");
              n.classList.remove("expanded");
              return;
            }
            chaptersBtn.click();
            n.classList.add("expanded");
            // scroll hacia la tarjeta si est√° fuera de vista (m√≥vil)
            setTimeout(() => {
              n.scrollIntoView({ behavior: "smooth", block: "center" });
            }, 50);
          });
        }
        function renderChaptersBox({
          card,
          response,
          requestedLang,
          pagesBox,
          extra,
          showMulti = false,
        }) {
          const list = response.chapters || [];
          const langUsed = response.mixed
            ? "mix"
            : response.langUsed || requestedLang;
          pagesBox.classList.remove("d-none");
          pagesBox.innerHTML = "";
          currentChapters = list;
          extra.textContent = `${list.length} cap√≠tulos (${langUsed})`;
          // Show chapters (only default language or mixed result)
          list.slice(0, 60).forEach((c, idx) => {
            const b = document.createElement("button");
            b.className = "btn btn-outline-frost btn-sm m-1";
            b.textContent = `Cap ${c.chapter || "?"}${
              response.mixed ? " [" + c.lang.toUpperCase() + "]" : ""
            }`;
            b.addEventListener("click", () =>
              openReader(c.id, c.chapter || "?", list, idx)
            );
            pagesBox.appendChild(b);
          });
          if (!list.length) {
            const msg = document.createElement("div");
            msg.className = "text-dim small";
            msg.textContent = "Sin cap√≠tulos en este idioma.";
            pagesBox.appendChild(msg);
          }
          // Determine incomplete translation (only if not mixed and default view)
          const incomplete =
            !response.mixed &&
            (list.length === 0 ||
              list.length < 5 ||
              (() => {
                const nums = list
                  .map((c) => parseFloat(c.chapter))
                  .filter((n) => !isNaN(n))
                  .sort((a, b) => a - b);
                if (!nums.length) return true;
                if (nums[0] > 1) return true;
                for (let i = 1; i < Math.min(nums.length, 25); i++) {
                  if (nums[i] - nums[i - 1] > 1.01) return true;
                }
                return false;
              })());
          if (!showMulti && incomplete) {
            const warn = document.createElement("div");
            warn.className = "alert alert-warning py-2 px-3 small mt-2";
            warn.style.fontSize = ".7rem";
            const msg = document.createElement("span");
            msg.textContent = "Traducci√≥n incompleta";
            warn.appendChild(msg);
            const btnVer = document.createElement("button");
            btnVer.type = "button";
            btnVer.className = "btn btn-gradient btn-xs ms-2";
            btnVer.style.fontSize = ".65rem";
            btnVer.textContent = "Ver";
            if (list.length > 0) {
              btnVer.addEventListener("click", () =>
                openReader(list[0].id, list[0].chapter || "?", list, 0)
              );
            } else {
              btnVer.disabled = true;
              btnVer.title = "Sin cap√≠tulos en este idioma";
            }
            const btnLang = document.createElement("button");
            btnLang.type = "button";
            btnLang.className = "btn btn-lang btn-xs ms-2";
            btnLang.style.fontSize = ".65rem";
            btnLang.textContent = "Lang";
            btnLang.addEventListener("click", () =>
              mixMore(card, pagesBox, extra, false, true)
            );
            warn.appendChild(btnVer);
            warn.appendChild(btnLang);
            pagesBox.appendChild(warn);
            return;
          }
          if (showMulti) {
            if (!window.multiLangSelection)
              window.multiLangSelection = new Set();
            const langsPresent = Array.from(
              new Set(list.map((c) => c.lang))
            ).filter(Boolean);
            if (!window.multiLangSelection.size && langsPresent.length)
              window.multiLangSelection = new Set(langsPresent);
            const bar = document.createElement("div");
            bar.className = "d-flex flex-wrap gap-1 mt-2 align-items-center";
            const makeChip = (code) => {
              const active = window.multiLangSelection.has(code);
              const b = document.createElement("button");
              b.type = "button";
              b.className = `btn btn-xs ${
                active ? "btn-gradient" : "btn-outline-frost"
              }`;
              b.style.fontSize = ".65rem";
              b.textContent = code.toUpperCase();
              b.addEventListener("click", () => {
                if (active) window.multiLangSelection.delete(code);
                else window.multiLangSelection.add(code);
                renderChaptersBox({
                  card,
                  response,
                  requestedLang,
                  pagesBox,
                  extra,
                  showMulti: true,
                });
              });
              return b;
            };
            langsPresent.forEach((l) => bar.appendChild(makeChip(l)));
            const othersBtn = document.createElement("button");
            othersBtn.type = "button";
            othersBtn.className = "btn btn-outline-frost btn-xs";
            othersBtn.style.fontSize = ".65rem";
            othersBtn.textContent = "OTROS";
            othersBtn.addEventListener("click", () =>
              mixMore(card, pagesBox, extra, true, true)
            );
            bar.appendChild(othersBtn);
            const apply = document.createElement("button");
            apply.type = "button";
            apply.className = "btn btn-gradient btn-xs";
            apply.style.fontSize = ".65rem";
            apply.textContent = "Aplicar";
            apply.disabled = window.multiLangSelection.size <= 1;
            apply.addEventListener("click", () => {
              const langs = Array.from(window.multiLangSelection);
              if (langs.length > 1)
                loadChaptersMulti(
                  card,
                  requestedLang,
                  langs,
                  pagesBox,
                  extra,
                  true
                );
            });
            bar.appendChild(apply);
            pagesBox.appendChild(bar);
          }
        }
        function loadChaptersMulti(
          card,
          baseLang,
          langs,
          pagesBox,
          extra,
          forceShowMulti
        ) {
          const param = langs.join(",");
          extra.textContent = "Cargando multi (" + param + ")...";
          fetch(
            `/api/ext/manga/${
              card.dataset.mid
            }/chapters?lang=${encodeURIComponent(
              baseLang
            )}&langs=${encodeURIComponent(param)}`
          )
            .then((r) => r.json())
            .then((ch) =>
              renderChaptersBox({
                card,
                response: ch,
                requestedLang: baseLang,
                pagesBox,
                extra,
                showMulti: forceShowMulti,
              })
            );
        }
        function reloadSingleLang(code, card, pagesBox, extra) {
          extra.textContent = "Cargando (" + code + " )...";
          fetch(
            `/api/ext/manga/${
              card.dataset.mid
            }/chapters?lang=${encodeURIComponent(code)}`
          )
            .then((r) => r.json())
            .then((ch) =>
              renderChaptersBox({
                card,
                response: ch,
                requestedLang: code,
                pagesBox,
                extra,
              })
            );
        }
        function mixMore(card, pagesBox, extra, silent, forceShowMulti) {
          const langsList = "es,en,pt-br";
          if (!silent) extra.textContent = "Cargando otros idiomas...";
          fetch(
            `/api/ext/manga/${
              card.dataset.mid
            }/chapters?lang=${encodeURIComponent(
              langSelect.value
            )}&langs=${encodeURIComponent(langsList)}`
          )
            .then((r) => r.json())
            .then((ch) =>
              renderChaptersBox({
                card,
                response: ch,
                requestedLang: langSelect.value,
                pagesBox,
                extra,
                showMulti: forceShowMulti,
              })
            );
        }
        function addExternal(results) {
          const existing = new Set(
            Array.from(grid.querySelectorAll("[data-mid]")).map(
              (e) => e.dataset.mid
            )
          );
          results.forEach((m) => {
            if (existing.has(m.id)) return; // evita duplicados si se repite b√∫squeda
            const frag = document.importNode(tpl, true);
            const card = frag.querySelector(".card");
            card.dataset.ext = "1";
            const titleEl = frag.querySelector("[data-title]");
            const rating = (m.contentRating || "").toLowerCase();
            let ratingClass = "bg-secondary";
            if (rating === "safe") ratingClass = "bg-success";
            else if (rating === "suggestive")
              ratingClass = "bg-warning text-dark";
            else if (rating === "erotica") ratingClass = "bg-danger";
            else if (rating === "pornographic") ratingClass = "bg-dark";
            titleEl.innerHTML = `<span class="badge badge-frost me-1">EXT</span><span class="badge ${ratingClass} me-1" title="${rating}">${rating
              .substring(0, 1)
              .toUpperCase()}</span><span class="title-text">${
              m.title || "(sin t√≠tulo)"
            }</span>`;
            const img = frag.querySelector("[data-img]");
            const ph = frag.querySelector("[data-ph]");
            const skel = frag.querySelector("[data-skel]");
            if (m.coverUrl) {
              // Usar la mec√°nica simple del homepage: asignar src directamente
              img.src = m.coverUrl;
              img.addEventListener("load", () => {
                skel?.remove();
                img.classList.add("is-loaded");
                ph && ph.remove();
              });
              img.addEventListener("error", () => {
                skel?.remove();
              });
            }
            const cardEl = frag.firstElementChild; // .card
            cardEl.dataset.mid = m.id;
            cardEl.dataset.title = m.title || "";
            cardEl.dataset.cover = m.coverUrl || "";
            cardEl.dataset.rating = m.contentRating || "";
            enrichCard(cardEl);
            grid.appendChild(frag);
          });
          updateCount();
        }
        const pagerEl = document.getElementById("extPager");
        let currentPage = 1;
        let lastQuery = "";
        let lastLang = "";
        let lastNsfw = false;
        let lastHasMore = false;
        function clearExternal() {
          grid.querySelectorAll("[data-ext]").forEach((e) => e.remove());
          if (noComicsMsg && localCount === 0) noComicsMsg.style.display = "";
        }
        function renderPager(hasMore) {
          if (!pagerEl) return;
          pagerEl.innerHTML = "";
          const makeBtn = (label, active, disabled, handler) => {
            const b = document.createElement("button");
            b.className = `btn btn-sm ${
              active ? "btn-gradient" : "btn-outline-frost"
            }`;
            b.textContent = label;
            if (disabled) b.disabled = true;
            if (handler) b.addEventListener("click", handler);
            pagerEl.appendChild(b);
            return b;
          };
          // Prev
          makeBtn("¬´", false, currentPage === 1, () => search(currentPage - 1));
          // Build list
          const pages = [];
          if (currentPage <= 5) {
            for (let p = 1; p <= currentPage; p++) pages.push(p);
          } else if (currentPage >= 6 && currentPage <= 10) {
            pages.push(1, "‚Ä¶", currentPage);
          } else {
            pages.push(1, 2, 3, 4, 5, "‚Ä¶", currentPage);
          }
          pages.forEach((p) => {
            if (p === "‚Ä¶") {
              const jumpBtn = document.createElement("button");
              jumpBtn.type = "button";
              jumpBtn.className = "btn btn-sm btn-outline-frost pager-ellipsis";
              jumpBtn.textContent = "‚Ä¶";
              jumpBtn.title = "Saltar a p√°gina";
              jumpBtn.addEventListener("click", () => {
                const modalEl = document.getElementById("jumpModal");
                const inputEl = document.getElementById("jumpInput");
                const goBtn = document.getElementById("jumpGo");
                if (!modalEl) return;
                const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                inputEl.value = "";
                goBtn.disabled = false;
                const submit = () => {
                  const val = inputEl.value.trim();
                  const num = parseInt(val, 10);
                  if (!val || isNaN(num) || num < 1) {
                    inputEl.classList.add("is-invalid");
                    return;
                  }
                  if (num === currentPage) {
                    bsModal.hide();
                    return;
                  }
                  bsModal.hide();
                  search(num);
                };
                goBtn.onclick = submit;
                inputEl.onkeydown = (e) => {
                  if (e.key === "Enter") {
                    submit();
                  }
                };
                modalEl.addEventListener(
                  "shown.bs.modal",
                  () => {
                    inputEl.focus();
                  },
                  { once: true }
                );
                bsModal.show();
              });
              pagerEl.appendChild(jumpBtn);
            } else {
              makeBtn(p, p === currentPage, false, () => {
                if (p !== currentPage) search(p);
              });
            }
          });
          // Next
          makeBtn("¬ª", false, !hasMore, () => {
            if (hasMore) search(currentPage + 1);
          });
          const info = document.createElement("span");
          info.className = "small text-dim align-self-center ms-2";
          info.textContent = `P√°gina ${currentPage}${
            hasMore ? " (hay m√°s)" : ""
          }`;
          pagerEl.appendChild(info);
        }
        function search(page = 1) {
          const activeRatings = getActiveRatings();
          const q = input.value.trim();
          const nsfw = document.getElementById("toggleNsfw").checked;
          const lang = langSelect.value;
          const newSearch =
            q !== lastQuery || nsfw !== lastNsfw || lang !== lastLang;
          if (newSearch) {
            currentPage = 1; // reset
          } else {
            currentPage = page;
          }
          lastQuery = q;
          lastNsfw = nsfw;
          lastLang = lang;
          localStorage.setItem("extLang", lang);
          clearExternal();
          pagerEl.innerHTML = '<span class="text-dim small">Cargando...</span>';
          const ratingsParam = activeRatings.join(",");
          fetch(
            `/api/ext/search?q=${encodeURIComponent(
              q
            )}&nsfw=${nsfw}&lang=${encodeURIComponent(
              lang
            )}&page=${currentPage}&ratings=${encodeURIComponent(ratingsParam)}`
          )
            .then((r) => r.json())
            .then((data) => {
              addExternal(data.results || []);
              lastHasMore = !!data.hasMore;
              renderPager(lastHasMore);
            })
            .catch(() => {
              pagerEl.innerHTML =
                '<span class="text-danger small">Error</span>';
            });
        }
        function getActiveRatings() {
          const act = Array.from(
            document
              .getElementById("ratingChips")
              .querySelectorAll(".chip.active")
          ).map((c) => c.dataset.rating);
          return act.length
            ? act
            : ["safe", "suggestive", "erotica", "pornographic"]; // fallback: todas si el usuario apaga todas
        }
        // Restaurar idioma guardado
        (function () {
          const saved = localStorage.getItem("extLang");
          if (saved && langSelect.querySelector(`option[value="${saved}"]`)) {
            langSelect.value = saved;
          }
        })();
        document
          .getElementById("toggleNsfw")
          .addEventListener("change", () => search(1));
        langSelect.addEventListener("change", () => search(1));
        btn.addEventListener("click", () => {
          search(1);
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") search(1);
        });
        // View toggle
        document.querySelectorAll(".view-btn").forEach((v) => {
          v.addEventListener("click", () => {
            document
              .querySelectorAll(".view-btn")
              .forEach((b) => b.classList.remove("is-active"));
            v.classList.add("is-active");
            grid.classList.toggle("list-view", v.dataset.view === "list");
          });
        });
        // Rating chips influence NSFW toggle automatically
        const chipWrap = document.getElementById("ratingChips");
        chipWrap.querySelectorAll(".chip").forEach((ch) => {
          ch.addEventListener("click", () => {
            ch.classList.toggle("active");
            // if any of erotica/pornographic active -> toggle nsfw
            const anyNSFW = Array.from(
              chipWrap.querySelectorAll(".chip.active")
            ).some((c) =>
              ["erotica", "pornographic", "suggestive"].includes(
                c.dataset.rating
              )
            );
            document.getElementById("toggleNsfw").checked = anyNSFW;
            search(1);
          });
        });
        // carga inicial (popular simple)
        if (auth) loadExternalFavorites();
        search(1);
      })();
    </script>
  </main>
  <style>
    .btn-lang {
      --c1: #6a5cff;
      --c2: #a66bff;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      color: #fff !important;
      border: none;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08),
        0 4px 10px -2px rgba(0, 0, 0, 0.5);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
    .btn-lang:before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: 0.3s;
      backdrop-filter: blur(2px);
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.15),
        rgba(255, 255, 255, 0)
      );
    }
    .btn-lang:hover:before {
      opacity: 1;
    }
    .btn-lang:active {
      transform: translateY(1px);
    }
  </style>
</html>
