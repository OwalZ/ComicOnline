<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}"
>
  <head>
    <title>Favoritos - ComicOnline</title>
  </head>
  <main>
    <div
      class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4 anim-fade-up"
    >
      <div>
        <h1 class="h4 fw-bold m-0">Mis Favoritos</h1>
        <div class="small text-dim">Locales y externos sincronizados</div>
      </div>
      <a th:href="@{/comics}" class="btn btn-outline-frost btn-sm"
        >Explorar m√°s</a
      >
    </div>
    <h2 class="h6 text-uppercase text-dim mt-2 mb-2">Locales</h2>
    <div class="row g-3 mb-5">
      <div class="col-12 col-sm-6 col-md-4 col-lg-3" th:each="f : ${favorites}">
        <div class="card h-100 shadow-sm">
          <div
            class="ratio ratio-4x3 bg-secondary-subtle d-flex align-items-center justify-content-center text-muted"
          >
            Portada
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title" th:text="${f.comic.title}"></h5>
            <p
              class="card-text small text-muted"
              th:text="${f.comic.author}"
            ></p>
            <div class="mt-auto d-flex gap-2">
              <a
                th:href="@{'/comics/' + ${f.comic.id}}"
                class="btn btn-sm btn-outline-primary"
                >Ver</a
              >
              <form
                th:action="@{'/favorites/' + ${f.comic.id} + '/remove'}"
                method="post"
                class="d-inline"
              >
                <button class="btn btn-sm btn-outline-danger">Quitar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div th:if="${#lists.isEmpty(favorites)}" class="text-muted small">
        No tienes favoritos locales.
      </div>
    </div>
    <h2 class="h6 text-uppercase text-dim mb-2">Externos</h2>
    <div class="row g-3 mb-4">
      <div
        class="col-12 col-sm-6 col-md-4 col-lg-3"
        th:each="e : ${extFavorites}"
      >
        <div class="card h-100 shadow-sm" data-ext="1">
          <div
            class="ratio ratio-4x3 bg-dark-subtle d-flex align-items-center justify-content-center overflow-hidden"
          >
            <img
              th:if="${e.coverUrl}"
              th:src="${e.coverUrl}"
              loading="lazy"
              decoding="async"
              style="width: 100%; height: 100%; object-fit: cover"
            />
            <div th:if="${e.coverUrl == null}" class="text-dim small">
              Sin portada
            </div>
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1">
              <span class="badge bg-info me-1">EXT</span
              ><span th:text="${e.title}"></span>
            </h5>
            <p class="small text-muted mb-3" th:text="${e.contentRating}"></p>
            <div class="mt-auto d-flex gap-2">
              <form
                th:action="@{'/api/ext/fav/toggle'}"
                method="post"
                class="d-inline"
                th:object="${e}"
                onsubmit="return false;"
              >
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  data-remove-ext
                  th:attr="data-id=${e.externalId}"
                >
                  Quitar
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div th:if="${#lists.isEmpty(extFavorites)}" class="text-muted small">
        No tienes favoritos externos.
      </div>
    </div>
    <script>
      (function () {
        const csrf = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector(
          'meta[name="_csrf_header"]'
        )?.content;
        document.querySelectorAll("[data-remove-ext]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const headers = { "Content-Type": "application/json" };
            if (csrf && csrfHeader) headers[csrfHeader] = csrf;
            fetch("/api/ext/fav/toggle", {
              method: "POST",
              headers,
              body: JSON.stringify({ id }),
            })
              .then((r) => (r.ok ? r.json() : null))
              .then((res) => {
                if (res && res.status === "removed") {
                  const card =
                    btn.closest(".col-12, .col-sm-6, .col-md-4, .col-lg-3") ||
                    btn.closest(".card");
                  if (card) card.remove();
                }
              });
          });
        });
      })();
    </script>
  </main>
</html>
