<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
  th:fragment="layout(title, content)"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:replace="${title}">ComicOnline</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
  </head>
  <body class="d-flex flex-column min-vh-100 theme-aurora">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 rounded-bottom-4">
      <div class="container">
        <a class="navbar-brand fw-bold" th:href="@{/}">ComicOnline</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNav"
          aria-controls="mainNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" th:href="@{/comics}">Cat√°logo</a>
            </li>
            <li class="nav-item" sec:authorize="isAuthenticated()">
              <a class="nav-link" th:href="@{/favorites}">Favoritos</a>
            </li>
            <li class="nav-item" sec:authorize="hasRole('ADMIN')">
              <a class="nav-link" th:href="@{/admin/comics}">Admin</a>
            </li>
          </ul>
          <div class="d-flex gap-2 align-items-center">
            <div sec:authorize="isAnonymous()">
              <a class="btn btn-outline-frost" th:href="@{/login}">Login</a>
              <a class="btn btn-gradient" th:href="@{/register}">Registro</a>
            </div>
            <div
              class="d-flex gap-2 align-items-center"
              sec:authorize="isAuthenticated()"
            >
              <div class="dropdown order-0">
                <button
                  class="btn btn-outline-frost rounded-circle p-0 overflow-hidden d-flex align-items-center justify-content-center position-relative"
                  style="width: 42px; height: 42px"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  title="Perfil"
                >
                  <img
                    th:if="${userEntity?.avatarUrl != null}"
                    th:src="${userEntity.avatarUrl + '?v=' + #dates.createNow().time}"
                    data-avatar
                    alt="avatar"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                  <span
                    th:if="${userEntity?.avatarUrl == null}"
                    data-avatar-fallback
                    class="fw-semibold"
                    style="font-size: 0.95rem"
                    th:text="${#authentication.principal?.username?.substring(0,1).toUpperCase()} ?: 'U'"
                    >U</span
                  >
                </button>
                <ul
                  class="dropdown-menu dropdown-menu-end shadow-sm small"
                  style="min-width: 180px"
                >
                  <li>
                    <h6
                      class="dropdown-header"
                      th:text="${#authentication.principal?.username}"
                    >
                      Usuario
                    </h6>
                  </li>
                  <li>
                    <a class="dropdown-item" th:href="@{/profile}">Profile</a>
                  </li>
                  <li>
                    <a class="dropdown-item" th:href="@{/settings}">Settings</a>
                  </li>
                  <li><a class="dropdown-item" href="#">Subscription</a></li>
                  <li><a class="dropdown-item" href="#">Wallet</a></li>
                </ul>
              </div>
              <form th:action="@{/logout}" method="post" class="m-0 order-1">
                <button class="btn btn-outline-frost" type="submit">
                  Logout
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="container mb-5 flex-grow-1" th:replace="${content}">
      <!-- page content -->
    </main>

    <footer class="text-white py-4 mt-auto">
      <div class="container text-center small">
        &copy;
        <span
          th:text="${#temporals.format(#temporals.createNow(), 'yyyy')}"
        ></span>
        ComicOnline
      </div>
      <div class="container text-center small">
        <span class="text-dim">Powered by Owal</span>
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      (function () {
        const k = "comicTheme";
        const s = localStorage.getItem(k) || "aurora";
        document.body.classList.add("theme-" + s);
        // Fallback si la imagen no carga
        document.querySelectorAll("img[data-avatar]").forEach((img) => {
          img.addEventListener("error", () => {
            const fallback = img.parentElement.querySelector(
              "[data-avatar-fallback]"
            );
            if (fallback) fallback.style.display = "";
            img.remove();
          });
        });
      })();
    </script>
  </body>
</html>
