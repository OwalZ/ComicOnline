<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
  th:fragment="layout(title, content)"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="theme-color" content="#0f1624" />
    <title th:replace="${title}">ComicOnline</title>
    <!-- Performance hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
    <!-- Bootstrap 5 CDN (preload then apply) -->
    <link
      rel="preload"
      as="style"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="d-flex flex-column min-vh-100 theme-aurora app-shell">
    <!-- Top App Bar -->
    <nav class="app-topbar navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid px-3 px-lg-4">
        <div class="d-flex align-items-center gap-3">
          <button
            class="navbar-toggler d-inline-flex d-lg-none"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasNav"
            aria-controls="offcanvasNav"
            aria-label="Men√∫"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand fw-bold me-2" th:href="@{/}">ComicOnline</a>
        </div>
        <div
          class="flex-grow-1 d-none d-lg-flex align-items-center px-lg-3 gap-4"
        >
          <ul class="app-nav list-unstyled d-flex align-items-center gap-3 m-0">
            <li><a class="app-nav-link" th:href="@{/comics}">Cat√°logo</a></li>
            <li sec:authorize="isAuthenticated()">
              <a class="app-nav-link" th:href="@{/favorites}">Favoritos</a>
            </li>
            <li sec:authorize="hasRole('ADMIN')">
              <a class="app-nav-link" th:href="@{/admin/comics}">Admin</a>
            </li>
          </ul>
          <div class="search-wrapper flex-grow-1">
            <input
              id="globalSearch"
              class="form-control form-control-sm app-search"
              placeholder="Buscar c√≥mic..."
              autocomplete="off"
            />
            <span class="search-icon" aria-hidden="true">üîç</span>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <button
            id="themeToggle"
            class="btn btn-outline-frost btn-sm theme-toggle-btn"
            type="button"
            title="Cambiar tema"
            aria-label="Cambiar tema"
          >
            <span class="icon-moon">üåô</span>
            <span class="icon-sun">‚òÄÔ∏è</span>
          </button>
          <div sec:authorize="isAnonymous()" class="d-flex gap-2">
            <a class="btn btn-outline-frost btn-sm" th:href="@{/login}"
              >Login</a
            >
            <a class="btn btn-gradient btn-sm" th:href="@{/register}"
              >Registro</a
            >
          </div>
          <div
            class="d-flex gap-2 align-items-center"
            sec:authorize="isAuthenticated()"
          >
            <div class="dropdown">
              <button
                class="btn btn-outline-frost rounded-circle p-0 overflow-hidden d-flex align-items-center justify-content-center position-relative avatar-btn"
                style="width: 42px; height: 42px"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="Perfil"
              >
                <img
                  th:if="${userEntity?.avatarUrl != null}"
                  th:src="${userEntity.avatarUrl + '?v=' + #dates.createNow().time}"
                  data-avatar
                  alt="avatar"
                  style="width: 100%; height: 100%; object-fit: cover"
                />
                <span
                  th:if="${userEntity?.avatarUrl == null}"
                  data-avatar-fallback
                  class="fw-semibold"
                  style="font-size: 0.95rem"
                  th:text="${#authentication.principal?.username?.substring(0,1).toUpperCase()} ?: 'U'"
                  >U</span
                >
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end shadow-sm small"
                style="min-width: 200px"
              >
                <li>
                  <h6
                    class="dropdown-header"
                    th:text="${#authentication.principal?.username}"
                  >
                    Usuario
                  </h6>
                </li>
                <li>
                  <a class="dropdown-item" th:href="@{/profile}">Perfil</a>
                </li>
                <li>
                  <a class="dropdown-item" th:href="@{/settings}">Ajustes</a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#">Suscripci√≥n (pronto)</a>
                </li>
                <li><a class="dropdown-item" href="#">Wallet (pronto)</a></li>
              </ul>
            </div>
            <form th:action="@{/logout}" method="post" class="m-0">
              <button class="btn btn-outline-frost btn-sm" type="submit">
                Salir
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>
    <!-- Side navigation / offcanvas -->
    <div
      class="offcanvas offcanvas-start text-bg-dark"
      tabindex="-1"
      id="offcanvasNav"
      aria-labelledby="offcanvasNavLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavLabel">Men√∫</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body d-flex flex-column gap-2 small">
        <a class="app-link" th:href="@{/comics}">Cat√°logo</a>
        <a
          class="app-link"
          th:href="@{/favorites}"
          sec:authorize="isAuthenticated()"
          >Favoritos</a
        >
        <a
          class="app-link"
          th:href="@{/admin/comics}"
          sec:authorize="hasRole('ADMIN')"
          >Admin</a
        >
        <hr />
        <div class="d-lg-none">
          <div sec:authorize="isAnonymous()" class="d-flex gap-2 mb-2">
            <a class="btn btn-outline-frost btn-sm w-50" th:href="@{/login}"
              >Login</a
            >
            <a class="btn btn-gradient btn-sm w-50" th:href="@{/register}"
              >Registro</a
            >
          </div>
          <form
            th:action="@{/logout}"
            method="post"
            sec:authorize="isAuthenticated()"
            class="m-0"
          >
            <button class="btn btn-outline-frost btn-sm w-100" type="submit">
              Salir
            </button>
          </form>
        </div>
      </div>
    </div>

    <div
      class="app-content container-fluid px-3 px-lg-4 pt-4 pb-5 flex-grow-1"
      th:replace="${content}"
    ></div>

    <footer class="text-white py-4 mt-auto app-footer">
      <div class="container text-center small">
        &copy;
        <span
          th:text="${#temporals.format(#temporals.createNow(), 'yyyy')}"
        ></span>
        ComicOnline
      </div>
      <div class="container text-center small">
        <span class="text-dim">Powered by Owal</span>
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script th:src="@{/js/app.js}"></script>
    <script>
      (function () {
        const btn = document.getElementById("themeToggle");
        if (!btn) return;
        const KEY = "comicTheme";
        function current() {
          const c =
            Array.from(document.body.classList).find((c) =>
              c.startsWith("theme-")
            ) || "theme-aurora";
          return c.replace("theme-", "");
        }
        btn.addEventListener("click", () => {
          const cur = current();
          const next = cur === "light" ? "aurora" : "light";
          document.body.classList.remove("theme-" + cur);
          document.body.classList.add("theme-" + next);
          localStorage.setItem(KEY, next);
        });
      })();
    </script>
  </body>
</html>
